---
title: "Explorando la independencia espacial"
subtitle: "ü¶å para datos de fototrampeo ü¶®"  
author: "Gabriel Andrade Ponce"
date: '`r Sys.Date()`'
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    seal: false
    nature:
      slideNumberFormat: "%current%"
      highlightStyle: github
      highlightLines: true
      ratio: 16:9
      countIncrementalSlides: false
   
---

```{r setup, include=FALSE}
library(tidyverse) # Easily Install and Load the 'Tidyverse'
library(sp) # Classes and Methods for Spatial Data
library(sf)
library(gghighlight) # Highlight Lines and Points in 'ggplot2'
library(showtext) # Using Fonts More Easily in R Graphs
library(ggtext)
library(ggspatial)
library(leaflet) # Create Interactive Web Maps with the JavaScript 'Leaflet' Library
library(AICcmodavg) # Model Selection and Multimodel Inference Based on (Q)AIC(c)
library(DHARMa)
library(MASS) # Support Functions and Datasets for Venables and Ripley's MASS
library(pgirmess)
library(ncf) # Spatial Covariance Functions
font_add_google("Fira Sans", "firasans") # Familia de tipo de letra
showtext_auto()

options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  fig.width=9, fig.height=3.5, fig.retina=3,
  out.width = "100%",
  cache = FALSE,
  echo = TRUE,
  message = FALSE, 
  warning = FALSE,
  fig.show = TRUE,
  hiline = TRUE,
  root.dir= rprojroot::find_rstudio_root_file()
)

```

```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
style_duo_accent(
  primary_color = "#035AA6", 
  secondary_color = "black",
  header_font_google = google_font("Cabin"),
  text_font_google   = google_font("Coming Soon", "400", "400i"),
  code_font_google   = google_font("Roboto")
)
```

```{r metathis, echo=FALSE}
library(metathis)
meta() %>%
  meta_name("github-repo" = "gpandradep/ind_spat_fototramp") %>% 
  meta_social(
    title = "Explorando la independencia espacial",
    description = paste(
      "Explorar la autocorrelaci√≥n espacial en datos provenientes de fototrampeo."
    ),
    url = "https://gpandradep.github.io/ind_spat_fototramp",
    image = "https://gpandradep.github.io/ind_spat_fototramp/share-card.png",
    image_alt = paste(
      "Title slide of Explorando la independencia espacial:", 
      "ü¶å para datos de fototrampeo ü¶®,", 
      "presented by Gabriel Andrade"
    ),
    og_type = "website",
    og_author = "Gabriel Andrade",
    twitter_card_type = "summary_large_image",
    twitter_creator = "@Gatorco_AP",
    twitter_site = "@Gatorco_AP"
  )
```


class: inverse, center, bottom
background-image: url("img/initial.jpg")
background-position: 50% 50%
background-size: cover

#`r rmarkdown::metadata$title`
## `r rmarkdown::metadata$subtitle`
### `r rmarkdown::metadata$author`; gpandradep@gmail.com
---

# ¬øAutocorrelaci√≥n espacial (ACS)?

En cualquier an√°lisis de informaci√≥n espacial la ACS puede influir sobre nuestros resultados o inferencias. 

**¬øQu√© es la ACS?**: Correlaci√≥n de una variable con ella misma, dada cierta distancia espacial. [(Fortin y Dale 2005)](https://doi.org/10.1017/CBO9780511542039).
--

```{r eval=FALSE, fig.align='center', message=FALSE, warning=FALSE, include=FALSE, out.width="50%"}
knitr::include_graphics("img/fig1.png")
```
---
class: inverse, center

### Primera ley de la grograf√≠a

```{r eval=FALSE, fig.align='center', message=FALSE, warning=FALSE out.width="50%"}
knitr::include_graphics("img/law.png")
```

*Tobler W., (1970) "A computer movie simulating urban growth in the Detroit region". Economic Geography, 46(Supplement): 234‚Äì240. *

---

### Es muy com√∫n en ecolog√≠a

Muchos de los fen√≥menos ecol√≥gicos dependen de caracter√≠sticas espaciales resultando en parches o gradientes.
Probablemente, nada funcionar√≠a en los ecosistemas sin la existencia de una estructura espacial. Imag√≠nense un mundo espacialmente homog√©neo.


```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, out.width="50%"}
knitr::include_graphics("img/drone.jng")
```



## ¬ø Qu√© puede causar ACS?

### Los factores m√°s com√∫nes son [(Dorman *et al.* 2007)](https://onlinelibrary.wiley.com/doi/10.1111/j.2007.0906-7590.05171.x):
.pull-left[
1- **Procesos biol√≥gicos**: especiaci√≥n, dispersi√≥n interacciones ecol√≥gicas entre otras, son fen√≥menos relacionados con el espacio.

2- **Especificaci√≥n del muestreo**: Distancia de las unidades de muestreo respecto al movimiento de la especie (resoluci√≥n o grano).

3- **Especificaci√≥n del modelo**: Relaciones no lineales o modelos que no incluyen una variable ambiental determinante que causa la estructura espacial de la variable de inter√©s.]

.pull-right[

```{r echo=FALSE, message=FALSE, warning=FALSE, out.width="80%", fig.align='center', fig.subcap= "Kachouie, et al. 2020. Association Factor for Identifying Linear and Nonlinear Correlations in Noisy Conditions"}
knitr::include_graphics("https://www.mdpi.com/entropy/entropy-22-00440/article_deploy/html/images/entropy-22-00440-g001.png")
```
]

---

## ¬øPor qu√© importa la indepedencia espacial?

Pese a que la estructura espacial es com√∫n en las variables ecol√≥gicas y ambientales ignorarla no es una buena pr√°ctica.

### 1- Razones pr√°cticas

La mayor√≠a de los test estad√≠sticos asumen independencia de los datos. Uno de los m√°s comunes son los modelos lineales

$$ y_i = \alpha + \beta x_i +\epsilon_i$$

La independencia de este tipo de modelos es asumida en los residuales, ya que se espera que se distribuyan normalmente con media 0 y varianza $\sigma2$. Es decir que, se espera que cada residual no sea dependiente de otro dentro de la misma distribuci√≥n.

---

### Las consecuencias

#### Error tipo I

Infermimos patrones significativos donde no los hay
Por la pseudoreplicaci√≥n se asumen m√°s grados de libertad de los que hay
PRecisi√≥n artificial de los Errores e intervalos de confianza de par√°metros

---

class: inverse, center

## La ACS es ¬ømala o buena?

```{r echo=FALSE, message=FALSE, warning=FALSE, out.width= "40%"}
knitr::include_graphics("https://c.tenor.com/EHVGbpNqP2oAAAAd/todo-depende-del-cristal-del-cual-se-mira-tadeo.gif")
```

---
class: inverse, center

## La ACS es ¬ø mala o buena ?

.pull-left[
### Buena
Si tu pregunta ecol√≥gica se relaciona con el espacio. Entonces la autocorrelaci√≥n espacial ayudar√° a informar sobre c√≥mo ocurren los procesos ecol√≥gicos en el espacio y a que escala.

```{r echo=FALSE, message=FALSE, warning=FALSE, out.width="50%", fig.align='center', fig.subcap= "https://doi.org/10.1007/s10336-010-0583-z"}
knitr::include_graphics("img/SCR.png")
```

]
.pull-right[
### No tan buena

Es un gran problema para la prueba estad√≠stica de hip√≥tesis y para las predicciones de las mismas, porque viola el supuesto (de casi todas las pruebas) de independencia. Lo que nos puede llevar a cometer errores  **.white[Tipo I]** o incluso invertir la relaci√≥n de la pendiente en algunos an√°lisis.

```{r echo=FALSE, message=FALSE, warning=FALSE, out.width= "30%"}
knitr::include_graphics("img/erroresTipoIyII.png")
```


]
---

## Detectar y cuantificar la ACS

El primer paso antes de empezar con pruebas o modelos m√°s complejos para lidiar con la ACS, es identificar si es en efecto un problema.
.pull-left[

### Nota
- 1- Si se realizan pruebas que asumen independencia, pero no son regresiones. La ACS debe verificarse en los datos "crudos". Ej. pruebas de t, patrones de actividad, entre otras.

- 2- En regresiones donde se modela el efecto de posibles variables ambientales, la ACS se debe verificar en los residuales.
]
.pull-right[

### Procedimientos

Existen diversos procedimientos, pero los m√°s comunes son la **I de Moran** o correlograma de Moran y los **semi-variogramas**.

Para este ejercicio usaremos los correlogramas de Moran, pero recomiendo que exploren las ventajas que puede ofrecer un semi-variograma.

]
---
### Correlograma de I de Moran

 
$$I= \frac{n}{\sum_{i} \sum_{j}w_{ij}}  \frac{\sum_{i=1}^{n} \sum_{j=1}^{n} w_{i,j}(X_{i}- \overline{X})(X_{j}- \overline{X})} {(X_{i}- \overline{X})^2}$$
donde $n$ es el n√∫mero de unidades $i$ y $j$; $X$ es la variable de inter√©s; $\overline{X}$ es la media de $X$; y $w_{√≠j}$ es la matriz de pesos espaciales. El valor de $I$ puede tomar valores de **1** (autocorrelaci√≥n positiva), **-1** (autocorrelaci√≥n positiva) o **0** (distribuci√≥n aleatoria).

.pull-left[
```{r echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', out.height="100%", out.width="700%"}
knitr::include_graphics("img/correl_ejem.png")
```
]
.pull-right[ <br>
#### El correlograma es la inspecci√≥n gr√°fica de la ACS a las diferentes distancias de pares de puntos de muestreo.]
---

class: inverse, center

## Estudio de caso

Tenemos un muestreo de c√°maras trampa en agrupamientos, con una distancia m√≠nima de ~ 500m. Intuitivamente un evaluador te dir√≠a que a esta distancia no hay independencia espacial. Particularmente, para especies grandes y que se mueven mucho.


```{r echo=FALSE, message=FALSE, warning=FALSE, out.width= "100%", out.height="60%"}

CTtable <- read.csv("Data/CTtable.csv") %>%  # Base de coordenadas de c√°maras
 dplyr::select(Station, utm_x, utm_y ) # Seleccionar columnas que usaremos

# Generar objeto espacial para el mapa
CT_points <- SpatialPoints(cbind(CTtable$utm_x, 
                                 CTtable$utm_y),
                           proj4string = CRS('+proj=utm +datum=WGS84 +zone=14 +towgs84=0,0,0')) 

# Proyectar a WGS solo para este paso
CT_points <- spTransform(CT_points, "+proj=longlat +datum=WGS84")

UMA_proj <- st_transform(UMA, "+proj=longlat +datum=WGS84")
UMA <- st_read("Shape/UMA.shp") # Leer el shape de la UMA
# Es importante verificar que este en la misma proyecci√≥n (CRS)

# Generar el mapa
m <- leaflet() %>%
  addProviderTiles(providers$Esri.WorldImagery, group="Satellite") %>%  # Add satellite data
  addProviderTiles(providers$Esri.WorldTopoMap, group="Base") %>% 
  addCircleMarkers(lng=coordinates(CT_points)[,1], lat=coordinates(CT_points)[,2], 
                   popup= paste(CTtable$Station)) %>%
  addPolygons(lng= st_coordinates(UMA_proj)[,1], lat = st_coordinates(UMA_proj)[,2],
              fillOpacity= 0) %>% 
  # Layers control
  addLayersControl(
    baseGroups = c("Satellite", "Base"),
    options = layersControlOptions(collapsed = FALSE)
  )
m

```

---
## Datos
### Ubicaci√≥n de c√°maras

```{r message=FALSE, warning=FALSE}

CTtable <- read.csv("Data/CTtable.csv") %>%  # Base de coordenadas de c√°maras
 dplyr::select(Station, utm_x, utm_y ) # Seleccionar columnas que usaremos
  
knitr::kable(head(CTtable))

```

---
## Datos
### Frecuencia de registro de especies

```{r echo=FALSE, message=FALSE, warning=FALSE}

freq_reg <- read.csv("Data/surveyReport/events_by_station2.csv") %>% # Datos de registros por estaci√≥n
  filter(Species == "Odocoileus virginianus") %>% # Filtrar especie
  left_join(CTtable, by= "Station") # Unir con la base da c√°maras

knitr::kable(head(freq_reg), 'html')
```

---
## Datos
### Registro de eventos por especie

```{r message=FALSE, warning=FALSE}
events_by_species <- read_csv("Data/surveyReport/events_by_species.csv") %>% 
  type.convert(n_events= col_double(), # Convertir tipo de columna
               n_stations= col_double()) %>% # Convertir tipo de columna
  mutate(Sp_n= paste("*",species,"*", " (n= ", n_events, " ) ", sep = "") ) # Columna para los nombres del eje
knitr::kable(head(freq_reg), 'html')

```
---
## N√∫mero de registros

```{r}
(ndetectionplot <- ggplot(events_by_species, # Datos
                          aes(x= reorder(Sp_n,n_events), #Ordenar sp 
                              y= n_events))+ # No. eventos
    geom_bar(stat= "identity")+  # Geometria
    gghighlight(species %in% c("Odocoileus virginianus"))+ # Se√±alar venados
    coord_flip()+ # Girar ejes
    labs(title = "Tabla de frecuencia de registro de especies", # T√≠tulo
      y= "N√∫mero de registros independientes", # Eje y
      x= NULL)+ # Sin eje x
    theme_minimal()+ # Tema
    theme(text = element_text(family = 'firasans', size = 16), # tipo de letra
      plot.title.position = 'plot', # Marco de posici√≥n
      plot.title = element_text(face = 'bold', # Negrillas 
        margin = margin(t = 2, r = 0, b = 7, l = 0, unit = "mm"), # Margenes
        hjust = 0.5), #posici√≥n central
      axis.text.y= element_markdown())) # It√°lica nombre de especies

```
---
## Histograma de registros



```{r}
(hist <- ggplot(freq_reg, aes(x= n_events))+ # Datos
    geom_histogram(binwidth = 3, color= "white")+ # Geometria
    labs(title = " Histograma n√∫mero de detecciones",
      x= "N√∫mero de detecciones",
      y= "Frecuencia") +
    theme_bw()+ # Tema
    theme(text = element_text(family = 'firasans', size = 16), # tipo de letra
          plot.title.position = 'plot', # Marco de posici√≥n
          plot.title = element_text(face = 'bold', # Negrillas 
                                    margin = margin(t = 2, r = 0, b = 7, l = 0, unit = "mm"), # Margenes
                                    hjust = 0.5)))

```

---
## Distribuci√≥n de los registros de ü¶å

```{r echo=FALSE, message=FALSE, warning=FALSE, out.width="80%", out.height="200%", fig.align='center', fig.asp = 9/16}
UMA <- st_read("Shape/UMA.shp") # Leer el shape de la UMA
# Es importante verificar que este en la misma proyecci√≥n (CRS)

# Mapa de registros

(map <- ggplot(UMA)+ # shape de uma
  geom_sf()+ # Graficar objeto espacial
  geom_point(data= freq_reg, aes(x=utm_x, y=utm_y, # Agregar puntos
                 size= n_events, color= n_events), # Tama√±o y color
             alpha=0.9)+ # Transparencia
  scale_size(range = c(1,20))+ # Escala del radio para los puntos
  labs(title= "Mapa de n√∫mero detecciones venado cola blanca",
       y= "Lat",
       x= "Lon",
       size= "N√∫mero de \ndetecciones",
       color=NULL)+
    annotation_scale(location = "bl", width_hint = 0.5, # Barra de escala
                     line_width=2, tick_height=10) +
    annotation_north_arrow(location = "tr", # Flecha de norte
                           height = unit(2.5, "cm"), width = unit(2.5, "cm"),
                           pad_x = unit(1, "in"), pad_y = unit(0.5, "in"),
                           style = north_arrow_fancy_orienteering)+
  theme_bw()+
    theme(text=element_text(size=15, family = "special"))+
  theme(text = element_text(family = 'firasans', size = 16), # tipo de letra
        plot.title.position = 'plot', # Marco de posici√≥n
        plot.title = element_text(face = 'bold', # Negrillas 
                                   # Margenes
                                  hjust = 0.5)))
```

---
## Modelando la frecuencia de captura del ü¶å

```{r message=FALSE, warning=FALSE}

covs.data<-read.csv("Data/covars.csv", header=TRUE) %>% # covariables
  dplyr::select(-X) # eliminar columna X

covs.data$Cluster<- as.character(covs.data$Cluster) # cluster es categ√≥rica

### Separar las variables n√∫mericas y categ√≥ricas
cov.num <- covs.data %>% 
  dplyr::select(where(is.numeric)) %>% # Seleccionar columnas num√©ricas
  scale() %>%  # estandarizar
  as.data.frame()

cov.fac <- covs.data %>% 
  dplyr::select(where(is.character)) # Seleccionar variables de caracter

sp_glmdata <- data.frame(cov.fac, cov.num) %>% # Unir covariables
  right_join(freq_reg, by= "Station")# Unir con la base de rgistros

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
knitr::kable(head(sp_glmdata, 4), 'html')
```

---

## Modelando la frecuencia de captura del ü¶å
Creamos algunos modelos que reflejan nuestras hip√≥tesis sobre las variables que afectan la frecuencia de captura.

```{r message=FALSE, warning=FALSE}
# Modelos lineales generalizados simples

# sin variables
m0 <- glm(n_events~ 1, data = sp_glmdata, family = "poisson")

# la frecuencia de registro afectada por la distancia a cultivo
m1 <- glm(n_events~ Dcrops, data = sp_glmdata, family = "poisson")

# la frecuencia de registro afectada por el verdor de la vegetaci√≥n
m2 <- glm(n_events~ MSAVI, data = sp_glmdata, family = "poisson")

# la frecuencia de registro afectada por la pendiente
m3 <- glm(n_events~ Slope, data = sp_glmdata, family = "poisson") 
          
# la frecuencia de registro afectada por la distancia a poblados
m4 <- glm(n_events~ Dpop_G, data = sp_glmdata, family = "poisson")

# la frecuencia de registro afectada por el tipo de habitat
m5 <- glm(n_events~ Habitat, data = sp_glmdata, family = "poisson" )
```
---

## Modelando la frecuencia de captura del ü¶å

Seg√∫n el criterio de informaci√≥n de AIC nuestro mejor modelo es aquel que incluye el h√°bitat.
```{r echo=FALSE, message=FALSE, warning=FALSE}
lista_mods <- list(m0, m1, m2, m3, m4, m5)
mod_names <- c("freq~ 1",
               "freq~ D_cultivos",
               "freq~ MSAVI",
               "freq~ Slope",
               "freq~ D_poblado",
               "freq~ Habitat"
               )

AIC <- aictab(lista_mods, modnames = mod_names, second.ord = F, sort = T)
knitr::kable(AIC, 'html', digits = 3)

```
---
## Procedemos a inspeccionar el modelo

Debido al car√°cter relativo del AIC es necesario verificar que el mejor modelo es un buen modelo. Un mal ajuste puede ser causado por la existencia de autocorrelaci√≥n en los residuales.

```{r message=FALSE, warning=FALSE}
# Debido a que para glm poisson los residuales no se definen directamente, 
#usamos simulateResiduals del paquete DHARMa
residuales <- simulateResiduals(fittedModel = m5, plot =F)

```


```{r fig.align='center', warning=FALSE, out.height="100%", out.width="70%"}
# Verificamos visualmente que el modelo cumpla los requisitos de la distribuci√≥n
plotQQunif(residuales)
```

---
class: inverse, center

# ¬øSer√° esta desviaci√≥n del ajuste causada por la autocorrelaci√≥n espacial?

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', out.height="40%", out.width="40%"}
knitr::include_graphics("https://c.tenor.com/n7Q-cdm8ZLkAAAAd/suspicious-fry-futurama.gif")
```


---
## Exploremos si existe autocorrelaci√≥n espacial

```{r}
# Creamos el data.frame para el an√°lisis
data_resm5 <- data.frame(res=residuals(residuales), # Residuales que creamos
                       x= sp_glmdata$utm_x,# coordenadas en x
                       y= sp_glmdata$utm_y) # coordenadas en y
```

### Ahora usamos la funci√≥n `correlog`, del paquete **nfc**

```{r message=FALSE, warning=FALSE}
m5_cor <- correlog(x=data_resm5$x, # coordenadas en x
         y=data_resm5$y, # coordenadas en y
         z=data_resm5$res, # variable de inter√©s
         na.rm=T, # en caso de NAs
         increment = 400, # Distancia m√≠nima de unidades
         resamp=500) # n√∫mero de iteraciones
```
---
class: center

## Correlograma

Ahora tenemos nuestro primer correlograma. Pueden hacerlo con la funci√≥n `plot(m5_cor)` o con el c√≥digo de ggplot del scrpit.


```{r echo=FALSE, message=FALSE, warning=FALSE}
cor_m5 <- data.frame(correlation=m5_cor$correlation, distance= m5_cor$mean.of.class, p= m5_cor$p)%>% 
  mutate(p_valor= if_else(p<0.025, "significativo", "no-significativo"))

ggplot(cor_m5,aes(x=distance, y=correlation))+
  geom_hline(yintercept = 0, linetype= "dashed")+
  geom_line( size=0.9)+
  geom_point(aes(colour= p_valor),size=3)+
  scale_x_continuous(breaks = seq(0,8000, by=500))+
  ylim(-1,1)+
  labs(x= "Unidades de distancia (m)", y= " Moran I", 
       title = " Correlograma residuales ")+
  theme_classic()+
  theme(text=element_text(size=15, family = "special" ),
        axis.text.x = element_text(angle = 45, hjust=1))

```
---
class: inverse

## La autocorrelaci√≥n espacial no es el problema

Ajustamos otro modelo que asumen una distribuci√≥n de error *binomial negativa*. Con ello nos damos cuenta que el problema era el tipo de distribuci√≥n.
```{r echo=FALSE, message=FALSE, warning=FALSE}
m5bn <- glm.nb(n_events~ Habitat, data = sp_glmdata)

residuales.bn <- simulateResiduals(fittedModel = m5bn, plot =F)

plotQQunif(residuales.bn)

```
---

class: inverse, center, midle

# Esto apenas es el comienzo
###Esto fue un ejercicio sencillo, pero lidiar con la ACS merece realizar diversas lecturas en el tema, conocer los supuestos de las t√©cnicas y aprender a interpretar los resultados.

###En caso de encontrar ACS y dependiendo de los objetivos es recomendable usar herramientas como modelos de m√≠nimos cuadrados generalizados (GLS), modelos mixtos, considerar a las coordenadas como covariables o modelos autorregresivos. 
NOTA: *la mayor√≠a de estas t√©cnicas asumen error de probabilidad con distribuci√≥n normal, por lo que en muchos casos los datos deben ser transformados*

---
class: center

### Ser√≠a casi irresponsable decirte que estas listo para enfrentarte a la ACS en la vida real, as√≠ que te recomiendo leer:

- 1- [Fox *et al.* 2015. Ecological Statistics: Contemporary theory and application](https://oxford.universitypressscholarship.com/view/10.1093/acprof:oso/9780199672547.001.0001/acprof-9780199672547)]
- 2- [Plant 2019. Spatial Data Analysis in Ecology and Agriculture Using R](https://www.routledge.com/Spatial-Data-Analysis-in-Ecology-and-Agriculture-Using-R/Plant/p/book/9780367732325)
- 3- [Dorman *et al.* 2007. Methods to account for spatial autocorrelation in the analysis of species distributional data: a review](https://onlinelibrary.wiley.com/doi/10.1111/j.2007.0906-7590.05171.x)
- 4- [Kuhn & Dorman 2012. Less than eight (and a half) misconceptions of spatial analysis](https://onlinelibrary.wiley.com/doi/full/10.1111/j.1365-2699.2012.02707.x)


```{r echo=FALSE, message=FALSE, warning=FALSE, out.height="50%", out.width="50%"}
knitr::include_graphics("https://3.bp.blogspot.com/-feLSjKOc0nA/VspNAqbdzuI/AAAAAAAABAs/D1w5W-BtOSY/s1600/cat%2Bspeed%2Breader.gif")

```

---
class: inverse
background-image: url("img/end.JPG")
background-position: 50% 50%
background-size: cover

## Gracias

